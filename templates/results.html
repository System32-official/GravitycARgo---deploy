<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GravitycARgo - Optimization Results</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
      :root {
        --primary: #0b2447;
        --secondary: #19376d;
        --accent: #576cbc;
        --success: #2ecc71;
        --warning: #f1c40f;
        --danger: #e74c3c;
        --light: #a5d7e8;
        --dark: #2c3e50;
        --transition: all 0.3s ease;
        --card-radius: 24px;
        --border: rgba(255, 255, 255, 0.1);
        --gray: #94a3b8;
        --gradient: linear-gradient(135deg, var(--primary), var(--accent));
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f8fafc;
        color: var(--dark);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background-image: radial-gradient(
            circle at 20% 20%,
            rgba(87, 108, 188, 0.05) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(11, 36, 71, 0.05) 0%,
            transparent 40%
          );
      }

      /* Navbar */
      .navbar {
        background: var(--gradient);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      }

      .navbar-brand {
        font-weight: 700;
        display: flex;
        align-items: center;
      }

      .navbar-brand i {
        font-size: 1.5rem;
        margin-right: 0.5rem;
      }

      /* Page header */
      .page-header {
        margin-bottom: 2rem;
      }

      .tech-badge {
        display: inline-flex;
        align-items: center;
        background: var(--gradient);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .tech-badge i {
        margin-right: 0.5rem;
      }

      /* Visualization container */
      .visualization-container {
        height: 70vh;
        position: relative;
        border-radius: var(--card-radius);
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition);
      }

      /* Server controls for AR View */
      .server-controls {
        padding: 1rem 1.5rem;
        border-top: 1px solid rgba(0, 0, 0, 0.07);
        background: white;
      }
      
      .server-status-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 0.5rem;
      }
      
      .server-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      
      .server-status-header h6 {
        margin: 0;
        font-weight: 600;
      }
      
      .status-badge {
        padding: 0.3rem 0.9rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
        background: var(--gray);
        color: white;
      }
      
      .status-badge.online {
        background: var(--success);
      }
      
      .status-badge.offline {
        background: var(--gray);
      }
      
      .status-badge.starting {
        background: var(--warning);
      }
      
      .server-info {
        margin-bottom: 1.25rem;
        font-size: 0.95rem;
      }
      
      .server-url {
        background: rgba(0, 0, 0, 0.03);
        padding: 0.75rem;
        border-radius: 8px;
        font-family: monospace;
        margin-bottom: 1rem;
        white-space: nowrap;
        overflow: auto;
        word-break: break-all;
        position: relative;
      }
      
      .copy-icon {
        position: absolute;
        right: 0.75rem;
        top: 0.75rem;
        cursor: pointer;
        color: var(--accent);
        transition: var(--transition);
      }
      
      .copy-icon:hover {
        color: var(--primary);
      }
      
      .server-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }
      
      .btn-start-server {
        background: var(--success);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: var(--transition);
      }
      
      .btn-start-server:hover {
        background: #27ae60;
        transform: translateY(-2px);
      }
      
      .btn-stop-server {
        background: var(--danger);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: var(--transition);
      }
      
      .btn-stop-server:hover {
        background: #c0392b;
        transform: translateY(-2px);
      }
      
      .btn-copy-url {
        background: var(--light);
        color: var(--dark);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: var(--transition);
      }
      
      .btn-copy-url:hover {
        background: #93c5fd;
      }

      /* Toast notifications */
      .toast-container {
        position: fixed;
        top: 25px;
        right: 25px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .toast {
        padding: 1rem 1.25rem;
        border-radius: 8px;
        background: white;
        color: var(--dark);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        min-width: 250px;
        max-width: 350px;
        opacity: 0;
        transform: translateX(25px);
        transition: all 0.3s ease;
      }
      
      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }
      
      .toast-success {
        border-left: 4px solid var(--success);
      }
      
      .toast-error {
        border-left: 4px solid var(--danger);
      }
      
      .toast-info {
        border-left: 4px solid var(--accent);
      }
      
      .toast-warning {
        border-left: 4px solid var(--warning);
      }

      /* Controls overlay */
      .controls-overlay {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 10;
      }

      .controls-overlay .btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        transition: var(--transition);
        background: white;
        color: var(--primary);
      }

      .controls-overlay .btn:hover {
        transform: scale(1.1);
        background: var(--accent);
        color: white;
      }

      .controls-overlay .btn.active {
        background: var(--accent);
        color: white;
      }

      /* Dashboard stats */
      .dashboard-grid {
        margin-bottom: 2rem;
      }

      .dashboard-stat-card {
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        height: 100%;
        display: flex;
        align-items: center;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .dashboard-stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--gradient);
      }

      .dashboard-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      /* Stat elements */
      .stat-icon {
        width: 60px;
        height: 60px;
        background: var(--gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1.5rem;
        flex-shrink: 0;
      }

      .stat-icon i {
        color: white;
        font-size: 1.8rem;
      }

      .stat-content {
        flex-grow: 1;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        color: var(--primary);
        line-height: 1.2;
      }

      .stat-label {
        color: #718096;
        margin: 0;
        font-size: 0.9rem;
        font-weight: 500;
      }

      /* Chart containers */
      .chart-container {
        background-color: white;
        border-radius: 16px;
        padding: 1.5rem;
        height: 100%;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
      }

      .chart-container:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      }

      .chart-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--primary);
        display: flex;
        align-items: center;
      }

      .chart-title i {
        margin-right: 0.5rem;
        color: var(--accent);
      }

      .chart-wrapper {
        height: 220px;
        position: relative;
      }

      /* Cards */
      .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: var(--card-radius);
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        transition: var(--transition);
      }

      .glass-card:hover {
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
      }

      .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        background: white;
      }

      .card-header.bg-gradient {
        background: var(--gradient);
      }

      .card-body {
        padding: 1.5rem;
      }

      /* Tables */
      .table-container {
        padding: 0;
      }

      .modern-table {
        margin-bottom: 0;
      }

      .modern-table th {
        font-weight: 600;
        color: var(--secondary);
        background-color: rgba(0, 0, 0, 0.02);
        border-bottom: 2px solid rgba(0, 0, 0, 0.05);
      }

      .modern-table td {
        vertical-align: middle;
      }

      .modern-table tr:hover {
        background-color: rgba(87, 108, 188, 0.05);
      }

      /* Action buttons */
      .actions-bar {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
        margin-bottom: 3rem;
      }

      .btn-action {
        background: var(--gradient);
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        min-width: 180px;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
      }

      .btn-action:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        color: white;
      }

      .btn-secondary-action {
        background: white;
        color: var(--primary);
        border: 1px solid #e2e8f0;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        min-width: 180px;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
      }

      .btn-secondary-action:hover {
        transform: translateY(-3px);
        background: #f8f9fa;
        color: var(--accent);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      /* Visualization components */
      .visualization-wrapper {
        position: relative;
        margin-bottom: 2.5rem;
      }

      .visualization-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: var(--card-radius);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: var(--transition);
      }

      .visualization-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .view-mode-toggle {
        display: flex;
        gap: 0.5rem;
      }

      .btn-mode {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        background: transparent;
        border: 1px solid rgba(0, 0, 0, 0.1);
        color: var(--gray);
        transition: var(--transition);
        font-weight: 500;
      }

      .btn-mode.active {
        background: var(--gradient);
        color: white;
        border: none;
      }

      .btn-mode:hover:not(.active) {
        background: rgba(87, 108, 188, 0.1);
        color: var(--accent);
      }

      .visualization-content {
        height: 70vh;
        position: relative;
      }

      /* Loading state */
      .loading-state {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(255, 255, 255, 0.8);
        z-index: 5;
        display: none;
      }

      .spinner-wrapper {
        margin-bottom: 1rem;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: var(--accent);
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Color legend */
      .color-legend {
        margin-top: 1.5rem;
      }

      .control-header {
        display: flex;
        align-items: center;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .control-header i {
        margin-right: 0.5rem;
        color: var(--accent);
      }

      .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      .color-box {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        margin-right: 0.5rem;
      }

      /* Layout */
      .content-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      /* Responsive design */
      @media (max-width: 1200px) {
        .visualization-container {
          height: 60vh;
        }
      }

      @media (max-width: 992px) {
        .modern-table th,
        .modern-table td {
          padding: 0.75rem 1rem;
        }
      }

      @media (max-width: 768px) {
        .visualization-container {
          height: 50vh;
        }

        .controls-overlay {
          top: 0.75rem;
          right: 0.75rem;
        }

        .controls-overlay .btn {
          width: 36px;
          height: 36px;
          font-size: 0.875rem;
        }

        .actions-bar {
          flex-direction: column;
          gap: 0.75rem;
          padding: 0 1rem;
        }

        .btn-action,
        .btn-secondary-action {
          width: 100%;
          min-width: unset;
        }
      }

      @media (max-width: 576px) {
        .section-title {
          font-size: 1.25rem;
        }

        .modern-table th,
        .modern-table td {
          padding: 0.75rem;
          font-size: 0.875rem;
        }

        .chart-container {
          padding: 1rem;
        }
      }

      /* Animation keyframes */
      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      /* New visualization control styles */
      .viz-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .viz-controls .btn {
        background: white;
        color: var(--primary);
        border: 1px solid rgba(0, 0, 0, 0.1);
        transition: var(--transition);
      }

      .viz-controls .btn:hover,
      .viz-controls .btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      /* Layer slider styling */
      .layer-slider-container {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 1rem;
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        max-width: 600px;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        z-index: 5;
      }

      .layer-slider-container .form-label {
        margin-bottom: 0;
        white-space: nowrap;
      }

      .layer-slider-container .form-range {
        min-width: 100px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-cube"></i>
          <span class="fw-bold">GravitycARgo</span>
        </a>
        <div>
          <a href="/" class="btn btn-sm btn-outline-light">
            <i class="fas fa-home me-1"></i>Home
          </a>
          <a href="/optimize" class="btn btn-sm btn-outline-light ms-2">
            <i class="fas fa-cogs me-1"></i>New Optimization
          </a>
        </div>
      </div>
    </nav>

    <div class="container-fluid px-4">
      <div class="row mb-4">
        <div class="col-12">
          <div class="page-header" data-aos="fade-down">
            <div class="tech-badge">
              <i class="fas fa-robot"></i>
              <span>AI-Powered Results</span>
            </div>
            <h1 class="text-center mb-3">Container Loading Results</h1>
            <p class="text-center text-muted">
              Optimized solution generated using advanced genetic algorithms
            </p>
          </div>
        </div>
      </div>

      <!-- 3D Visualization Section -->
      <div class="visualization-wrapper" data-aos="zoom-in">
        <div class="visualization-card">
          <div class="visualization-header">
            <div class="view-mode-toggle">
              <button class="btn btn-mode active" data-mode="3d">
                <i class="fas fa-cube"></i> 3D View
              </button>
              <button class="btn btn-mode" data-mode="ar">
                <i class="fas fa-vr-cardboard"></i> AR View
              </button>
              <button class="btn btn-mode" data-mode="layers">
                <i class="fas fa-layer-group"></i> Layers
              </button>
            </div>
            <div class="visualization-controls">
              <button class="btn" id="resetView" title="Reset View">
                <i class="fas fa-sync"></i>
              </button>
              <button
                class="btn"
                id="toggleFullscreen"
                title="Toggle Fullscreen"
              >
                <i class="fas fa-expand"></i>
              </button>
              <button class="btn" id="toggleGrid" title="Toggle Grid">
                <i class="fas fa-border-all"></i>
              </button>
              <button class="btn" id="toggleLabels" title="Toggle Item Labels">
                <i class="fas fa-tags"></i>
              </button>
              <button
                class="btn"
                id="showHeatmap"
                title="Show Weight Distribution"
              >
                <i class="fas fa-fire"></i>
              </button>
            </div>
          </div>

          <div class="visualization-content">
            {{ plot|safe }}
            <div class="controls-overlay">
              <button class="btn" id="resetView" title="Reset View">
                <i class="fas fa-sync"></i>
              </button>
              <button
                class="btn"
                id="toggleFullscreen"
                title="Toggle Fullscreen"
              >
                <i class="fas fa-expand"></i>
              </button>
              <button class="btn" id="toggleGrid" title="Toggle Grid">
                <i class="fas fa-border-all"></i>
              </button>
              <button class="btn" id="toggleLabels" title="Toggle Item Labels">
                <i class="fas fa-tags"></i>
              </button>
              <button
                class="btn"
                id="showHeatmap"
                title="Show Weight Distribution"
              >
                <i class="fas fa-fire"></i>
              </button>
            </div>
          </div>

          <!-- Server controls section for AR View -->
          <div class="server-controls" style="display: none;">
            <div class="server-status-card">
              <div class="server-status-header">
                <h6><i class="fas fa-server"></i> JSON Server Status</h6>
                <span class="status-badge" id="serverStatus">Offline</span>
              </div>
              <div class="server-info" id="serverInfo">
                <p><i class="fas fa-info-circle"></i> Start the server to enable AR view</p>
              </div>
              <div class="server-buttons">
                <button class="btn btn-start-server" id="startServerBtn">
                  <i class="fas fa-play"></i> Start AR
                </button>
                <button class="btn btn-stop-server" id="stopServerBtn" disabled>
                  <i class="fas fa-stop"></i> Stop AR
                </button>
                <button class="btn btn-copy-url" id="copyUrlBtn" disabled>
                  <i class="fas fa-copy"></i> Copy URL
                </button>
              </div>
            </div>
          </div>

          <div class="loading-state">
            <div class="spinner-wrapper">
              <div class="spinner"></div>
            </div>
            <p>Loading visualization...</p>
          </div>
        </div>
      </div>

      <!-- Enhanced Dashboard Stats -->
      <div class="dashboard-grid">
        <div class="row g-4">
          <div class="col-md-3 col-sm-6">
            <div
              class="dashboard-stat-card"
              data-aos="fade-up"
              data-aos-delay="100"
            >
              <div class="stat-icon">
                <i class="fas fa-chart-pie"></i>
              </div>
              <div class="stat-content">
                <h3 class="stat-value">
                  {% if report.volume_utilization is defined %} {{
                  report.volume_utilization|round(1) }}% {% else %} 0.0% {%
                  endif %}
                </h3>
                <p class="stat-label">Volume Utilization</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div
              class="dashboard-stat-card"
              data-aos="fade-up"
              data-aos-delay="200"
            >
              <div class="stat-icon">
                <i class="fas fa-boxes"></i>
              </div>
              <div class="stat-content">
                <h3 class="stat-value">
                  {{ container.items|length }}/{{ container.items|length +
                  container.unpacked_reasons|length }}
                </h3>
                <p class="stat-label">Items Packed</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div
              class="dashboard-stat-card"
              data-aos="fade-up"
              data-aos-delay="300"
            >
              <div class="stat-icon">
                <i class="fas fa-weight-hanging"></i>
              </div>
              <div class="stat-content">
                <h3 class="stat-value">
                  {{ container.total_weight|round(1) }} kg
                </h3>
                <p class="stat-label">Total Weight</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div
              class="dashboard-stat-card"
              data-aos="fade-up"
              data-aos-delay="400"
            >
              <div class="stat-icon">
                <i class="fas fa-cube"></i>
              </div>
              <div class="stat-content">
                <h3 class="stat-value">
                  {{ container.remaining_volume|round(2) }} m³
                </h3>
                <p class="stat-label">Space Remaining</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="content-grid">
        <div class="content-main">
          {% if warnings %}
          <div class="glass-card" data-aos="fade-up">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>Packing Warnings
              </h5>
            </div>
            <div class="card-body">
              <ul class="mb-0">
                {% for warning in warnings %}
                <li>{{ warning }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}

          <div
            class="glass-card mb-4 mt-4"
            data-aos="fade-up"
            data-aos-delay="150"
          >
            <div class="card-header bg-gradient">
              <h5 class="mb-0 text-white">
                <i class="fas fa-chart-bar me-2"></i>Loading Analytics
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-4">
                <div class="col-md-6">
                  <div class="chart-container">
                    <h6 class="chart-title">
                      <i class="fas fa-chart-pie me-2"></i>Volume Utilization
                    </h6>
                    <div class="chart-wrapper">
                      <canvas id="volumeUtilizationChart"></canvas>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="chart-container">
                    <h6 class="chart-title">
                      <i class="fas fa-weight-hanging me-2"></i>Weight
                      Distribution
                    </h6>
                    <div class="chart-wrapper">
                      <canvas id="weightDistributionChart"></canvas>
                    </div>
                  </div>
                </div>
                <div class="col-md-12">
                  <div class="chart-container">
                    <h6 class="chart-title">
                      <i class="fas fa-box me-2"></i>Items By Category
                    </h6>
                    <div class="chart-wrapper">
                      <canvas id="itemsByCategoryChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- View Controls Card -->
          <div class="glass-card mb-4" data-aos="fade-up" data-aos-delay="200">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-sliders-h me-2"></i>Visualization Controls
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-4">
                <div class="col-md-4">
                  <div class="control-section">
                    <div class="control-header">
                      <i class="fas fa-cut"></i>
                      <span>Cross-Section View</span>
                    </div>
                    <div class="section-controls mt-3">
                      <label
                        for="sectionSlider"
                        class="form-label d-flex justify-content-between"
                      >
                        <span>Depth</span>
                        <span id="sectionValue">100%</span>
                      </label>
                      <input
                        type="range"
                        class="form-range"
                        id="sectionSlider"
                        min="0"
                        max="100"
                        value="100"
                      />
                      <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        Adjust to see inside the container
                      </small>
                    </div>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="control-section">
                    <div class="control-header">
                      <i class="fas fa-layer-group"></i>
                      <span>Layer Navigation</span>
                    </div>
                    <div class="section-controls mt-3">
                      <div class="d-flex gap-2 align-items-center">
                        <button
                          class="btn btn-sm btn-outline-primary"
                          id="prevLayer"
                        >
                          <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="flex-grow-1 text-center">
                          <span class="layer-indicator" id="currentLayer"
                            >All Layers</span
                          >
                        </div>
                        <button
                          class="btn btn-sm btn-outline-primary"
                          id="nextLayer"
                        >
                          <i class="fas fa-chevron-right"></i>
                        </button>
                      </div>
                      <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        Navigate through container layers
                      </small>
                    </div>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="control-section">
                    <div class="control-header">
                      <i class="fas fa-palette"></i>
                      <span>Color Scheme</span>
                    </div>
                    <div class="section-controls mt-3">
                      <select class="form-select" id="colorScheme">
                        <option value="item">By Item Type</option>
                        <option value="weight">By Weight</option>
                        <option value="stability">By Stability</option>
                        <option value="layer">By Layer</option>
                      </select>
                      <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        Change item coloring method
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <div class="color-legend mt-4">
                <div class="control-header mb-3">
                  <i class="fas fa-info-circle"></i>
                  <span>Color Legend</span>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <div class="legend-item">
                      <span
                        class="color-box"
                        style="background-color: #3b82f6"
                      ></span>
                      <span>Standard Items</span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="legend-item">
                      <span
                        class="color-box"
                        style="background-color: #ef4444"
                      ></span>
                      <span>Heavy Items</span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="legend-item">
                      <span
                        class="color-box"
                        style="background-color: #10b981"
                      ></span>
                      <span>Fragile Items</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="glass-card mt-4" data-aos="fade-up" data-aos-delay="250">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-box-check me-2"></i>Packed Items
              </h5>
            </div>
            <div class="card-body table-container">
              <div class="table-responsive">
                <table
                  class="table table-hover modern-table"
                  id="packedItemsTable"
                >
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Position</th>
                      <th>Dimensions</th>
                      <th>Weight</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in container.items %}
                    <tr data-item-id="{{ item.name }}">
                      <td>
                        {{ item.name }} {% if item.bundle == 'YES' and
                        item.quantity > 1 %}
                        <br />
                        <small class="text-muted">
                          Bundle of {{ item.quantity }} (Original: {{
                          item.original_dims[0] }}×{{ item.original_dims[1]
                          }}×{{ item.original_dims[2] }})
                        </small>
                        {% endif %}
                      </td>
                      <td>
                        ({{ item.position[0]|round(2) }}, {{
                        item.position[1]|round(2) }}, {{
                        item.position[2]|round(2) }})
                      </td>
                      <td>
                        {{ item.dimensions[0]|round(2) }}×{{
                        item.dimensions[1]|round(2) }}×{{
                        item.dimensions[2]|round(2) }}
                      </td>
                      <td>{{ item.weight }} kg</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="glass-card mt-4" data-aos="fade-up" data-aos-delay="300">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">
                <i class="fas fa-box-open me-2"></i>Unpacked Items
              </h5>
            </div>
            <div class="card-body table-container">
              <div class="table-responsive">
                <table class="table table-hover modern-table">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Dimensions</th>
                      <th>Weight</th>
                      <th>Load Bear</th>
                      <th>Support Found</th>
                      <th>Space Available</th>
                      <th>Detailed Reason</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for name, (reason, item) in
                    container.unpacked_reasons.items() %}
                    <tr>
                      <td>{{ name }}</td>
                      <td>
                        {{ item.dimensions[0] }}×{{ item.dimensions[1] }}×{{
                        item.dimensions[2] }}m
                      </td>
                      <td>{{ item.weight }}kg</td>
                      <td>{{ item.load_bear }}kg</td>
                      <td>
                        {% if "support" in reason.lower() %}
                        <span class="badge bg-danger">
                          <i class="fas fa-times"></i> No
                        </span>
                        {% else %}
                        <span class="badge bg-success">
                          <i class="fas fa-check"></i> Yes
                        </span>
                        {% endif %}
                      </td>
                      <td>
                        {% if "space" in reason.lower() %}
                        <span class="badge bg-danger">
                          <i class="fas fa-times"></i> No
                        </span>
                        {% else %}
                        <span class="badge bg-success">
                          <i class="fas fa-check"></i> Yes
                        </span>
                        {% endif %}
                      </td>
                      <td>{{ reason }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="actions-bar">
        <a href="/download_report" class="btn btn-action">
          <i class="fas fa-download me-2"></i>Download Report
        </a>
        <a href="/report" class="btn btn-action">
          <i class="fas fa-chart-bar me-2"></i>View Detailed Report
        </a>
        <a href="/optimize" class="btn btn-secondary-action">
          <i class="fas fa-redo me-2"></i>New Optimization
        </a>
      </div>
    </div>
    <!-- Data holder for chart values rendered by Jinja -->
    <div id="chartData" style="display: none;"
         data-volume-utilization='{{ report.volume_utilization | default(0) | round(1) }}'
         data-total-weight='{{ container.total_weight | default(0) }}'
         data-category-labels='{{ (category_counts.keys() | list) | default([]) | tojson | safe }}'
         data-category-data='{{ (category_counts.values() | list) | default([]) | tojson | safe }}'>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.127.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.127.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.127.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.1/gsap.min.js"></script>
    <script>
      AOS.init({
          duration: 800,
          easing: 'ease-in-out',
          once: true
      });

      document.addEventListener('DOMContentLoaded', function() {
          setupAnalyticsCharts();
          setupEventListeners();
          initServerControls(); // Initialize the JSON Server controls
          init3DView();
          
          // Initial check for server status
          if (document.querySelector('.btn-mode[data-mode="ar"]').classList.contains('active')) {
            checkServerStatus();
          }
      });

      function setupEventListeners() {
        // Fix duplicate reset view buttons
        const resetViewBtns = document.querySelectorAll('#resetView');
        resetViewBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            // Reset 3D view camera position
            resetCameraPosition();
          });
        });

        // Toggle fullscreen
        const fullscreenBtns = document.querySelectorAll('#toggleFullscreen');
        fullscreenBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            toggleFullscreen();
          });
        });

        // Toggle grid
        const gridBtns = document.querySelectorAll('#toggleGrid');
        gridBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            this.classList.toggle('active');
            toggleGrid();
          });
        });

        // Toggle labels
        const labelBtns = document.querySelectorAll('#toggleLabels');
        labelBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            this.classList.toggle('active');
            toggleItemLabels();
          });
        });

        // Toggle heatmap
        const heatmapBtns = document.querySelectorAll('#showHeatmap');
        heatmapBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            this.classList.toggle('active');
            toggleWeightHeatmap();
          });
        });

        // Navigation between layers
        const prevLayerBtn = document.getElementById('prevLayer');
        const nextLayerBtn = document.getElementById('nextLayer');

        if (prevLayerBtn) {
          prevLayerBtn.addEventListener('click', function() {
            navigateLayers('prev');
          });
        }

        if (nextLayerBtn) {
          nextLayerBtn.addEventListener('click', function() {
            navigateLayers('next');
          });
        }

        // Section slider
        const sectionSlider = document.getElementById('sectionSlider');
        const sectionValue = document.getElementById('sectionValue');

        if (sectionSlider) {
          sectionSlider.addEventListener('input', function() {
            const depth = this.value;
            sectionValue.textContent = `${depth}%`;
            setCrossSectionDepth(depth);
          });
        }

        // Color scheme selector
        const colorScheme = document.getElementById('colorScheme');

        if (colorScheme) {
          colorScheme.addEventListener('change', function() {
            changeColorScheme(this.value);
          });
        }

        // View mode buttons
        const viewModeButtons = document.querySelectorAll('.btn-mode');

        viewModeButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            viewModeButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const mode = this.getAttribute('data-mode');
            changeViewMode(mode);
          });
        });
      }

      function setupAnalyticsCharts() {
        const chartDataSource = document.getElementById('chartData');
        // Retrieve data from data-* attributes, providing defaults and parsing JSON
        const placedVolume = parseFloat(chartDataSource.dataset.volumeUtilization || '0');
        const totalWeight = parseFloat(chartDataSource.dataset.totalWeight || '0');
        let categoryLabels = [];
        let categoryData = [];
        try {
            categoryLabels = JSON.parse(chartDataSource.dataset.categoryLabels || '[]');
        } catch (e) {
            console.error("Error parsing category labels:", e, chartDataSource.dataset.categoryLabels);
            categoryLabels = []; // Fallback to empty array on error
        }
        try {
            categoryData = JSON.parse(chartDataSource.dataset.categoryData || '[]');
        } catch (e) {
            console.error("Error parsing category data:", e, chartDataSource.dataset.categoryData);
            categoryData = []; // Fallback to empty array on error
        }
        const unusedVolume = 100 - placedVolume;

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#0b2447',
                    bodyColor: '#334155',
                    bodyFont: {
                        size: 14
                    },
                    titleFont: {
                        size: 16,
                        weight: 'bold'
                    },
                    caretSize: 8,
                    cornerRadius: 8,
                    padding: 15,
                    displayColors: true,
                    borderColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 1,
                    boxPadding: 5
                },
                datalabels: {
                    color: '#fff',
                    font: {
                        weight: 'bold'
                    },
                    formatter: (value) => {
                        // Ensure value is a number before formatting
                        if (typeof value !== 'number' || value < 5) return '';
                        return value.toFixed(1) + '%';
                    }
                }
            }
        };

        // 1. Volume Utilization Chart (Pie Chart)
        const volumeCtx = document.getElementById('volumeUtilizationChart').getContext('2d');
        // Data is now read from chartDataSource above

        new Chart(volumeCtx, {
            type: 'doughnut',
            data: {
                labels: ['Utilized Space', 'Unused Space'],
                datasets: [{
                    data: [placedVolume, unusedVolume], // Use JS variable
                    backgroundColor: [
                        'rgba(87, 108, 188, 0.85)',
                        'rgba(226, 232, 240, 0.5)'
                    ],
                    borderColor: [
                        'rgba(87, 108, 188, 1)',
                        'rgba(226, 232, 240, 0.8)'
                    ],
                    borderWidth: 1,
                    hoverOffset: 6
                }]
            },
            options: {
                ...commonOptions,
                cutout: '65%',
                plugins: {
                    ...commonOptions.plugins,
                    datalabels: {
                        color: function(context) {
                            return context.dataIndex === 0 ? '#fff' : '#334155';
                        },
                        formatter: (value) => {
                            return (typeof value === 'number' ? value.toFixed(1) : '0.0') + '%';
                        },
                        font: {
                            weight: 'bold',
                            size: 14
                        }
                    },
                    tooltip: {
                        ...commonOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const rawValue = typeof context.raw === 'number' ? context.raw : 0;
                                return context.label + ': ' + rawValue.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });

        // 2. Weight Distribution Chart (Bar Chart)
        const weightCtx = document.getElementById('weightDistributionChart').getContext('2d');
        // Data is now read from chartDataSource above

        new Chart(weightCtx, {
            type: 'bar',
            data: {
                labels: ['Front', 'Middle', 'Back'], // Example labels, adjust if needed
                datasets: [{
                    label: 'Weight Distribution',
                    // Use JS variable
                    data: [
                        totalWeight * 0.35,
                        totalWeight * 0.4,
                        totalWeight * 0.25
                    ],
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(87, 108, 188, 0.7)',
                        'rgba(16, 185, 129, 0.7)'
                    ],
                    borderColor: [
                        'rgba(59, 130, 246, 1)',
                        'rgba(87, 108, 188, 1)',
                        'rgba(16, 185, 129, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                ...commonOptions,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Weight (kg)'
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    ...commonOptions.plugins,
                    legend: {
                        display: false
                    },
                    tooltip: {
                        ...commonOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const rawValue = typeof context.raw === 'number' ? context.raw : 0;
                                return context.label + ': ' + rawValue.toFixed(1) + ' kg';
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        formatter: (value) => (typeof value === 'number' ? value.toFixed(1) : '0.0') + ' kg',
                        color: '#334155',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        });

        // 3. Items By Category Chart (Doughnut Chart)
        const categoryCtx = document.getElementById('itemsByCategoryChart').getContext('2d');
        // Data is now read from chartDataSource above

        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categoryLabels, // Use JS variable
                datasets: [{
                    label: 'Items by Category',
                    data: categoryData, // Use JS variable
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(239, 68, 68, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(168, 85, 247, 0.7)'
                        // Add more colors if needed based on actual categories
                    ],
                    borderColor: [
                        'rgba(59, 130, 246, 1)',
                        'rgba(16, 185, 129, 1)',
                        'rgba(239, 68, 68, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(168, 85, 247, 1)'
                        // Add more border colors if needed
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                ...commonOptions,
                cutout: '60%',
                plugins: {
                    ...commonOptions.plugins,
                    tooltip: {
                        ...commonOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const rawValue = context.raw !== undefined ? context.raw : 0;
                                return context.label + ': ' + rawValue;
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value, ctx) => {
                            if (typeof value !== 'number' || !ctx.chart.data.datasets || !ctx.chart.data.datasets[0] || !ctx.chart.data.datasets[0].data) {
                                return '';
                            }
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.forEach(data => {
                                if (typeof data === 'number') {
                                    sum += data;
                                }
                            });
                            if (sum === 0) return '0.0%';
                            let percentage = (value * 100 / sum);
                            // Only show label if percentage is >= 5%
                            return percentage >= 5 ? percentage.toFixed(1) + "%" : '';
                        },
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 12
                        }
                    }
                }
            }
        });
      }

      // Placeholder functions for 3D visualization controls
      function init3DView() {
        console.log("3D view initialization - would normally set up Three.js scene");
      }

      function resetCameraPosition() {
        console.log("Resetting camera position");
      }

      function toggleFullscreen() {
        const vizContent = document.querySelector('.visualization-content');

        if (!document.fullscreenElement) {
          if (vizContent.requestFullscreen) {
            vizContent.requestFullscreen();
          } else if (vizContent.webkitRequestFullscreen) {
            vizContent.webkitRequestFullscreen();
          } else if (vizContent.msRequestFullscreen) {
            vizContent.msRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
      }

      function toggleGrid() {
        console.log("Toggling grid visibility");
      }

      function toggleItemLabels() {
        console.log("Toggling item labels");
      }

      function toggleWeightHeatmap() {
        console.log("Toggling weight heatmap");
      }

      function navigateLayers(direction) {
        const layerIndicator = document.getElementById('currentLayer');
        const currentLayer = layerIndicator.textContent;

        if (currentLayer === 'All Layers') {
          if (direction === 'next') {
            layerIndicator.textContent = 'Layer: 1';
          }
        } else {
          const layerNum = parseInt(currentLayer.replace('Layer: ', ''));

          if (direction === 'next' && layerNum < 10) {
            layerIndicator.textContent = `Layer: ${layerNum + 1}`;
          } else if (direction === 'prev' && layerNum > 1) {
            layerIndicator.textContent = `Layer: ${layerNum - 1}`;
          } else if (direction === 'prev' && layerNum === 1) {
            layerIndicator.textContent = 'All Layers';
          }
        }

        console.log(`Navigating to ${layerIndicator.textContent}`);
      }

      function setCrossSectionDepth(depth) {
        console.log(`Setting cross-section depth to ${depth}%`);
      }

      function changeColorScheme(scheme) {
        console.log(`Changing color scheme to: ${scheme}`);
      }

      function changeViewMode(mode) {
        console.log(`Changing view mode to: ${mode}`);
        
        const serverControls = document.querySelector('.server-controls');
        if (mode === 'ar') {
          serverControls.style.display = 'block';
          checkServerStatus();
        } else {
          serverControls.style.display = 'none';
        }
      }
      
      let serverRunning = false;
      let serverUrl = '';
      
      function initServerControls() {
        const arViewBtn = document.querySelector('.btn-mode[data-mode="ar"]');
        const startServerBtn = document.getElementById('startServerBtn');
        const stopServerBtn = document.getElementById('stopServerBtn');
        const copyUrlBtn = document.getElementById('copyUrlBtn');
        
        arViewBtn.addEventListener('click', function() {
          document.querySelector('.server-controls').style.display = 'block';
          checkServerStatus();
        });
        
        startServerBtn.addEventListener('click', function() {
          if (!serverRunning) {
            startJsonServer();
          }
        });
        
        stopServerBtn.addEventListener('click', function() {
          if (serverRunning) {
            stopJsonServer();
          }
        });
        
        copyUrlBtn.addEventListener('click', function() {
          if (serverUrl) {
            navigator.clipboard.writeText(serverUrl)
              .then(() => {
                showToast('URL copied to clipboard', 'success');
              })
              .catch(err => {
                showToast('Failed to copy URL: ' + err, 'error');
              });
          }
        });
      }
      
      async function startJsonServer() {
        try {
          updateServerStatus('starting');
          
          const response = await fetch('/start_json_server', {
            method: 'POST'
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Server started in a new terminal window
            serverRunning = true;
            serverUrl = data.url;
            
            // Give user immediate feedback
            updateServerStatus('online', serverUrl);
            showToast('JSON server started in a new terminal window. Check the terminal for details.', 'success');
          } else {
            throw new Error(data.error || 'Failed to start server');
          }
        } catch (error) {
          console.error('Server start error:', error);
          updateServerStatus('error', null, error.message);
          showToast('Failed to start server: ' + error.message, 'error');
        }
      }
      
      async function checkLocalJsonServer() {
        try {
          const response = await fetch('/check_local_server');
          const data = await response.json();
          
          if (data.success && data.running) {
            serverRunning = true;
            serverUrl = data.url;
            updateServerStatus('online', serverUrl);
            return true;
          }
          return false;
        } catch (error) {
          console.error('Error checking local JSON server:', error);
          return false;
        }
      }
      
      async function stopJsonServer() {
        try {
          const serverStatus = document.getElementById('serverStatus');
          serverStatus.textContent = 'Stopping...';
          document.getElementById('stopServerBtn').disabled = true;
          
          const response = await fetch('/stop_json_server', {
            method: 'POST'
          });
          
          const data = await response.json();
          
          if (data.success) {
            serverRunning = false;
            updateServerStatus('offline');
            showToast('JSON server stopped', 'info');
          } else {
            throw new Error(data.error || 'Failed to stop server');
          }
        } catch (error) {
          console.error('Server stop error:', error);
          showToast('Failed to stop server: ' + error.message, 'error');
          document.getElementById('stopServerBtn').disabled = false;
        }
      }
      
      async function checkServerStatus() {
        try {
          const response = await fetch('/check_json_server_status');
          const data = await response.json();
          
          if (data.running) {
            serverRunning = true;
            serverUrl = data.url;
            updateServerStatus('online', serverUrl);
          } else {
            updateServerStatus('offline');
          }
        } catch (error) {
          console.error('Failed to check server status:', error);
          updateServerStatus('offline');
        }
      }
      
      function updateServerStatus(status, url = null, errorMsg = null) {
        const serverStatus = document.getElementById('serverStatus');
        const serverInfo = document.getElementById('serverInfo');
        const startServerBtn = document.getElementById('startServerBtn');
        const stopServerBtn = document.getElementById('stopServerBtn');
        const copyUrlBtn = document.getElementById('copyUrlBtn');
        
        serverStatus.className = 'status-badge';
        
        switch (status) {
          case 'online':
            serverStatus.textContent = 'Online';
            serverStatus.classList.add('online');
            startServerBtn.disabled = true;
            stopServerBtn.disabled = false;
            copyUrlBtn.disabled = false;
            
            serverInfo.innerHTML = `
              <p><i class="fas fa-check-circle text-success"></i> Server is running</p>
              <div class="server-url">
                ${url}
                <i class="fas fa-copy copy-icon" onclick="navigator.clipboard.writeText('${url}').then(() => showToast('URL copied to clipboard', 'success'))"></i>
              </div>
              <p class="mb-0"><i class="fas fa-info-circle"></i> Use this URL in your AR application</p>
            `;
            break;
            
          case 'starting':
            serverStatus.textContent = 'Starting...';
            serverStatus.classList.add('starting');
            startServerBtn.disabled = true;
            stopServerBtn.disabled = true;
            copyUrlBtn.disabled = true;
            serverInfo.innerHTML = `
              <p><i class="fas fa-spinner fa-spin"></i> Starting server, please wait...</p>
            `;
            break;
            
          case 'error':
            serverStatus.textContent = 'Error';
            serverStatus.classList.add('offline');
            startServerBtn.disabled = false;
            stopServerBtn.disabled = true;
            copyUrlBtn.disabled = true;
            serverInfo.innerHTML = `
              <p><i class="fas fa-exclamation-circle text-danger"></i> Error: ${errorMsg || 'Failed to start server'}</p>
              <p class="mb-0">Please try again or check the server logs.</p>
            `;
            break;
            
          default:
            serverStatus.textContent = 'Offline';
            serverStatus.classList.add('offline');
            startServerBtn.disabled = false;
            stopServerBtn.disabled = true;
            copyUrlBtn.disabled = true;
            serverInfo.innerHTML = `
              <p><i class="fas fa-info-circle"></i> Start the server to enable AR view</p>
            `;
            break;
        }
      }
      
      function showToast(message, type = 'info') {
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
          toastContainer = document.createElement('div');
          toastContainer.className = 'toast-container';
          document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = message;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 3000);
      }
    </script>
  </body>
</html>
